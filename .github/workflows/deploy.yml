name: React App Deployment

# Triggers
on:
  push:
    branches: [master]

  # Allows you to run this manually from the Actions tab for debugging
  workflow_dispatch:

# Concurrency (it will delete the exisiting pipeline runs if a new one is triggered)
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

# Global environment variables
env:
  aws_region: ap-south-1
  ECR_REPOSITORY:  react-banking-app
  IMAGE_TAG: ${{ github.sha }}

# Permissions
permissions:
  contents: read

# Jobs
jobs:
  build-secure-deploy:
    name: Build, Secure, Optimize and Deploy React App to AWS ECS
    runs-on: ubuntu-latest

    steps:
    #stage 1: Checkout Code
    - name: Checkout Code
      uses: actions/checkout@v4

    #stage 2: Setup Docker Buildx( required for advanced caching)
    - name: Setup Docker Buildx
      uses: docker/setup-buildx-action@v3

    #stage 3: Configure AWS Credentials
    - name: Login to AWS ECR
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.aws_region }}

    #stage 4: Login to Amazon ECR
    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    #stage 5: Build Phase (With caching)
    - name: Build Fat Image 
      uses: docker/build-push-action@v5
      with:
        context: .
        file: Dockerfile
        load: true  #  keep image local (dont push yet) so we can scan it # this caches your layers in Github Actions
        tags: fat-image:latest
        cache-from: type=gha
        cache-to: type=gha,mode=max

    #stage 6: Scan Phase (Security Scanning using Trivy)
    - name: Run Trivy vulnerability scan
      uses: aquasecurity/trivy-action@master
      with:
        image-ref: fat-image:latest
        format: 'table'
        exit-code: '1'
        severity: 'CRITICAL,HIGH'
        ignore-unfixed: true
        vuln-type: 'os,library'

    #stage 7: OPTIMIZATION PHASE (Using Docker Slim)/
    - name: Minify Image using SlimtoolKit
      run: |
        echo "Running SlimToolkit..."
        docker run --rm \
          -v /var/run/docker.sock:/var/run/docker.sock \
          dslim/slim build \
          --target fat-image:latest \
          --tag slim-image:latest \
          --http-probe=false \
          --include-path /usr/share/nginx/html 

    #stage 8: Push Phase
    - name: Push Optimized Image to ECR
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
      run: |
        echo "Retagging local slim image for ECR..."
          
        # 1. Tag 'slim-image' with the ECR Format + SHA
        docker tag slim-image:latest $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
        
        # 2. Tag 'slim-image' with ECR Format + latest
        docker tag slim-image:latest $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        # 3. Push
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:latest
        
        echo "::notice::ðŸš€ Deployed Optimized Image: $ECR_REGISTRY/$ECR_REPOSITORY:${{ env.IMAGE_TAG }}"